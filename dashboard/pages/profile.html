<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update ID</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Additional CSS for modern styling -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <!-- Custom styles -->
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            margin-top: 50px;
            max-width: 600px;
        }
        .form-group label {
            font-weight: bold;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .navbar {
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
        }
        .error-message {
            color: red;
            display: none;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="animate__animated animate__fadeInDown">Update your profile</h1>
        <form id="editProfileForm">
            <div class="form-group">
                <label for="profileImage">Profile Image</label>
                <input type="file" class="form-control-file" id="profileImageFile" accept="image/*">
            </div>
            <div class="form-group">
                <label for="fullName">Full Name</label>
                <input type="text" class="form-control" id="fullName" placeholder="Enter full name">
            </div>
            <div class="form-group">
                <label for="address">Address</label>
                <input type="text" class="form-control" id="address" placeholder="Enter address">
            </div>
            <div class="form-group">
                <label for="dobDayMonthyear">Date of Birth</label>
                <input type="text" class="form-control" id="dobDayMonthyear" placeholder="Enter date of birth (DD/MM/yyyy)">
            </div>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" class="form-control" id="email" placeholder="Enter email">
            </div>
            <button type="submit" class="btn btn-primary">Save</button>
        </form>
        <div class="error-message" id="errorMessage">Unable to save profile. Please try again.</div>
    </div>
    <nav class="navbar fixed-bottom navbar-light bg-light">
        <!-- Navbar contents -->
        <a class="navbar-brand" href="../index.html">Home</a>
        <a class="navbar-brand" href="signin.html">Profile</a>
        <a class="navbar-brand" href="#">Settings</a>
    </nav>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD3mvLJORKunKc5HjLh73NJ1SkByp6797c",
            authDomain: "youthspring-af954.firebaseapp.com",
            databaseURL: "https://youthspring-af954-default-rtdb.firebaseio.com",
            projectId: "youthspring-af954",
            storageBucket: "youthspring-af954.firebasestorage.app",
            messagingSenderId: "190059933611",
            appId: "1:190059933611:web:871f54b6d282452337acee",
            measurementId: "G-24SVNJJKDC"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Handle form submission
        document.getElementById("editProfileForm").addEventListener("submit", (e) => {
            e.preventDefault();
            var user = firebase.auth().currentUser;
            if (user) {
                var profileImageFile = document.getElementById("profileImageFile").files[0];
                if (profileImageFile) {
                    var storageRef = firebase.storage().ref();
                    var profileImageRef = storageRef.child('profile_images/' + user.uid + '/' + profileImageFile.name);
                    profileImageRef.put(profileImageFile).then((snapshot) => {
                        snapshot.ref.getDownloadURL().then((url) => {
                            saveProfile(user.uid, url);
                        });
                    }).catch((error) => {
                        showError(error);
                        console.error("Error uploading image: ", error);
                    });
                } else {
                    saveProfile(user.uid, null);
                }
            } else {
                showError("No user is signed in.");
                console.log("No user is signed in.");
            }
        });

        async function saveProfile(userId, profileImageUrl) {
            var profileData = {
                profileImage: profileImageUrl,
                fullName: document.getElementById("fullName").value,
                address: document.getElementById("address").value,
                dobDayMonthyear: document.getElementById("dobDayMonthyear").value,
                email: document.getElementById("email").value
            };
            try {
                await db.collection("users").doc(userId).set(profileData);
                window.location.href = "dashboard.html";
            } catch (error) {
                showError(error);
                console.error("Error writing document: ", error);
            }
        }

        function showError(error) {
            const errorMessageElement = document.getElementById("errorMessage");
            errorMessageElement.style.display = "block";
            if (error.code === 'auth/email-already-in-use') {
                errorMessageElement.textContent = "This email already exists. Please login instead.";
            } else if (error.code === 'auth/invalid-email') {
                errorMessageElement.textContent = "Invalid email. Please check the email format.";
            } else if (error.code === 'auth/weak-password') {
                errorMessageElement.textContent = "Weak password. Please use a stronger password.";
            } else {
                errorMessageElement.textContent = `Error saving profile: ${error.message || error}`;
            }
        }
    </script>
</body>
</html>
